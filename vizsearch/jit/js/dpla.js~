jQuery(document).ready(function($){
	var $searchForm = $("#searchForm");
	$searchForm.on("submit",function(e){
		var submit = $searchForm.find('[type="submit"]').attr("disabled","disabled"),
		    params = $searchForm.serialize(),
		    $results = $("#results").empty();
		var facetQueryString = "&facet=subject&facet=creator&facet=language";
		var url = "http://api.dp.la/dev/item/?" + params + facetQueryString + "&callback=?";
		alert(url);
		$.getJSON(url)
		    .done(function(data){
			    var retrievedCount=0;
			    var output = '',
				numResults = (data.num_found) ? data.num_found : 0;
			    output += '<strong>' + numResults + '</strong> results found:<br />';
			    $.each(data.docs,function(i,item){
				    var facets = {};
				    $.each(['subject', 'creator', 'language'], function(i, facetName){
					    facets[facetName+'s'] = [];
					    var currentFacet = facets[facetName+'s'];
					    for(key in data.facets[facetName]) {
						currentFacet.push({
							title: key,
							    count: data.facets[facetName][key]
							    });
					    }
					    output += '<div class="result"><h2>Result ' + (i + 1) + '</h2>' + JSON.stringify(item) + '</div>';
					    retrievedCount++;
					});
				    $results.append(output);
				    $searchForm[0].reset();

				    var treeMapData = {"level":0,"name":"DPLA Results","id":"DPLA Results","data":{"$color":71,"$area":data.num_found,"retrievedItems": retrievedCount, "totalItems":data.num_found},"children":[]};

				    showTreeMap(treeMapData);
				})
				.fail(function(){
					alert('Glaring error');
				    })
				.always(function(){
					submit.removeAttr("disabled");
				    });
			    return false;
			});
	    });